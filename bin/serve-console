#!/usr/bin/env python
import os
import pathlib
import sys
parent = os.path.join(os.path.abspath(os.path.dirname(__file__)), "..")
sys.path.append(parent)

import console
import http.server
import socketserver

static_dir = pathlib.Path(parent) / "build" / "console"
console.ensure_path_to(static_dir, clean=True)
static_dir = static_dir.resolve()

console.render_to_directory(
    dst_root=static_dir,
    ctx=console.local_context.snapshot,
    dry_run=False, overwrite=True)

os.chdir(str(static_dir.resolve()))
port = 8020


class MagicHTMLHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.rewrite_endpoint()
        return super().do_GET()

    def rewrite_endpoint(self):
        path = self.translate_path(self.path)
        new_path = self.path
        if os.path.exists(path + ".html"):
            new_path += ".html"
        elif os.path.exists(path + "/index.html"):
            new_path += "/index.html"
        else:
            return
        print("REWROTE {} => {}".format(self.path, new_path))
        self.path = new_path

handler = MagicHTMLHandler
httpd = socketserver.TCPServer(("", port), handler)
print("Serving CONSOLE on {}".format(port))
httpd.serve_forever()
