{% extends "_partial/layout.html" %}
{% set title = "Moldyboot Login" %}

{% set css_files = ["normalize.min", "milligram.min"] %}
{% block inline_css %}{% include "_partial/main.css" %}{% endblock %}

{% block body %}
<div class="container">
    <main class="wrapper">
        <h2 class="title">Login to Moldyboot</h2>
        <form action="#" id="login-form">
            <fieldset>
                <label for="login-username">Username</label>
                <input id="login-username" type="text">
                <label for="login-password">Password</label>
                <input id="login-password" type="password">
                <input id="login-button" class="button-primary" value="send" type="submit">
                <div id="login-error" class="container" style="display: none">Incorrect username or password.</div>
            </fieldset>
        </form>
    </main>
</div>
{% endblock %}

{% set js_files = ["superagent.min", "moldyboot"] %}
{% block inline_js %}
<script type="application/javascript">
    "use strict";

    // Start generating a new key asap.
    var newKey = window.keys.generate()
    .then(function(keyBlob) {
        console.log("generated new key");
        return keyBlob;
    });

    var el = document.getElementById.bind(document);
    var $username = el("login-username");
    var $password = el("login-password");
    var $loginButton = el("login-button");
    var $loginStatus = el("login-error");

    $loginButton.removeAttribute("disabled");

    // Submit form against the API, not the console
    el("login-form").addEventListener("submit", function(event) {
        event.preventDefault();
        $loginButton.setAttribute("disabled", true);
        var username = $username.value,
            password = $password.value;

        newKey
        .then(function (keyBlob) {return window.keys.storage.saveKey(keyBlob, username)})
        .then(function() { return (new Client(username)).login(password); })
        .then(function () {
            $loginButton.removeAttribute("disabled");
            $loginStatus.style.display = "none";
            window.location.href = "{{ endpoints.console }}/console";
        })
        .catch(function (event) {
            $loginButton.removeAttribute("disabled");
            $username.value = "";
            $password.value = "";
            $loginStatus.style.display = "";
            console.log(event);
        })
    });
</script>
{% endblock %}
